from core.game_state import GameState
from core.constants import BLACK, WHITE

from ai.BaseAgent import BaseAgent
from ai.BeginnerAgent import BeginnerAgent
from ai.IntermediateAgent import IntermediateAgent
from ai.AdvancedAgent import AdvancedAgent


class PlayerVsAgentMode:
    def __init__(self, human_color=BLACK, agent_cls=IntermediateAgent):
        self.state = GameState()
        self.human_color = human_color
        self.agent_color = WHITE if human_color == BLACK else BLACK
        self.agent: BaseAgent = agent_cls(self.agent_color)

    def handle_human_click(self, row: int, col: int):
        if self.state.game_over:
            return {
                "success": False,
                "reason": "game_over",
                "game_over": True,
                "winner": self.state.winner,
            }

        if self.state.current_player != self.human_color:
            return {
                "success": False,
                "reason": "not_human_turn",
                "game_over": self.state.game_over,
                "winner": self.state.winner,
            }

        success = self.state.apply_move(row, col)

        if not success:
            return {
                "success": False,
                "reason": "invalid_human_move",
                "game_over": self.state.game_over,
                "winner": self.state.winner,
            }

        agent_move = None
        if (not self.state.game_over) and (self.state.current_player == self.agent_color):
            agent_move = self.agent.get_move(self.state)
            if agent_move is not None:
                self.state.apply_move(*agent_move)

        return {
            "success": True,
            "reason": None,
            "game_over": self.state.game_over,
            "winner": self.state.winner,
            "current_player": self.state.current_player,
            "last_agent_move": agent_move,
            "valid_moves": self.state.board.get_valid_moves(self.state.current_player)
                            if not self.state.game_over else [],
        }

    def get_board(self):
        return self.state.board.grid

    def get_current_player(self):
        return self.state.current_player
